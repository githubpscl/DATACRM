"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7182],{7182:function(e,r,n){n.d(r,{AuthProvider:function(){return g},a:function(){return m},k:function(){return d}});var o=n(7437),t=n(2265),a=n(9376),i=n(5526);let s=(0,t.createContext)(void 0),l="datacrm-auth-session",u="datacrm-last-activity",c=["mousedown","mousemove","keypress","scroll","touchstart","click"],d=async e=>{let{data:{session:r}}=await i.OQ.auth.getSession();if(!(null==r?void 0:r.access_token)&&e.includes("/auth/"))throw Error("Not authenticated");return(await new Promise(e=>setTimeout(e,500)),e.includes("/analytics"))?{analytics:null}:e.includes("/customers")?{customers:[]}:e.includes("/campaigns")?{campaigns:[]}:{data:null}};function g(e){let{children:r}=e,[d,g]=(0,t.useState)(null),[m,f]=(0,t.useState)(null),[_,h]=(0,t.useState)(!0),p=(0,a.useRouter)(),D=(0,t.useRef)(null),v=(0,t.useRef)(Date.now()),y=(0,t.useCallback)((e,r)=>{try{let n={user:e,token:r,timestamp:Date.now()};localStorage.setItem(l,JSON.stringify(n)),localStorage.setItem(u,Date.now().toString())}catch(e){console.error("Error saving session:",e)}},[]),z=(0,t.useCallback)(()=>{try{localStorage.removeItem(l),localStorage.removeItem(u)}catch(e){console.error("Error clearing session:",e)}},[]),w=(0,t.useCallback)(()=>{try{let e=localStorage.getItem(l),r=localStorage.getItem(u);if(e&&r){let n=JSON.parse(e),o=parseInt(r);if(Date.now()-o<6e5)return g(n.user),f(n.token),v.current=o,!0;z()}}catch(e){console.error("Error loading session:",e),z()}return!1},[z]),A=(0,t.useCallback)(()=>{let e=Date.now();v.current=e;try{localStorage.setItem(u,e.toString())}catch(e){console.error("Error updating last activity:",e)}},[]),E=(0,t.useCallback)(()=>{D.current&&clearTimeout(D.current),A(),D.current=setTimeout(()=>{console.log("Session expired due to inactivity"),z(),g(null),f(null),window.location.href="/login"},6e5)},[A,z]),T=(0,t.useCallback)(()=>{let e=parseInt(localStorage.getItem(u)||"0"),r=Date.now();d&&r-e>6e5&&(console.log("Session expired during validity check"),z(),g(null),f(null),window.location.href="/login")},[d,z]);(0,t.useEffect)(()=>{(async()=>{try{console.log("\uD83D\uDE80 [AUTH INIT] Starting authentication initialization");let t=w();if(console.log("\uD83D\uDCBE [AUTH INIT] LocalStorage session loaded: ".concat(t)),!t){var e,r,o;console.log("\uD83D\uDD0D [AUTH INIT] Checking Supabase session...");let{data:{session:t}}=await i.OQ.auth.getSession();if(console.log("\uD83D\uDD0D [AUTH INIT] Supabase session result:",{hasSession:!!t,hasUser:!!(null==t?void 0:t.user),userEmail:null==t?void 0:null===(e=t.user)||void 0===e?void 0:e.email}),null==t?void 0:t.user){let{getCurrentUserOrganization:e,isSuperAdmin:a}=await Promise.resolve().then(n.bind(n,5526));console.log("\uD83D\uDC51 [AUTH INIT] Checking super admin status...");let i=await a(t.user.email||"");console.log("\uD83D\uDC51 [AUTH INIT] Super admin result: ".concat(i));let s=null,l="user";if(i)console.log("\uD83D\uDC51 [AUTH INIT] Setting up super admin user"),l="super_admin",s={id:"system",name:"System Administration"};else{console.log("\uD83C\uDFE2 [AUTH INIT] Checking organization for regular user...");let r=await e();console.log("\uD83C\uDFE2 [AUTH INIT] Organization result:",{data:r.data,error:r.error}),(s=r.data)?(console.log("✅ [AUTH INIT] User has organization, setting admin role"),l="admin"):console.log("❌ [AUTH INIT] User has no organization")}let u={id:t.user.id,email:t.user.email||"",firstName:(null===(r=t.user.user_metadata)||void 0===r?void 0:r.firstName)||"Demo",lastName:(null===(o=t.user.user_metadata)||void 0===o?void 0:o.lastName)||"User",role:l,organizationId:null==s?void 0:s.id,organization:s?{id:s.id,name:s.name,subscription_plan:s.subscription_plan}:void 0};console.log("\uD83D\uDC64 [AUTH INIT] Final user data set:",u),g(u),f(t.access_token),y(u,t.access_token)}else console.log("❌ [AUTH INIT] No valid session found")}}catch(e){console.error("❌ [AUTH INIT] Error initializing auth:",e)}finally{console.log("✅ [AUTH INIT] Authentication initialization complete"),h(!1)}})();let{data:{subscription:e}}=i.OQ.auth.onAuthStateChange(async(e,r)=>{var o,t,a;if(console.log("\uD83D\uDD04 [AUTH STATE] Auth state changed - Event: ".concat(e)),console.log("\uD83D\uDD04 [AUTH STATE] Session data:",{hasSession:!!r,hasUser:!!(null==r?void 0:r.user),userEmail:null==r?void 0:null===(o=r.user)||void 0===o?void 0:o.email}),null==r?void 0:r.user){let{getCurrentUserOrganization:e,isSuperAdmin:o}=await Promise.resolve().then(n.bind(n,5526));console.log("\uD83D\uDC51 [AUTH STATE] Checking super admin status...");let i=await o(r.user.email||"");console.log("\uD83D\uDC51 [AUTH STATE] Super admin result: ".concat(i));let s=null,l="user";if(i)console.log("\uD83D\uDC51 [AUTH STATE] Setting up super admin user"),l="super_admin",s={id:"system",name:"System Administration"};else{console.log("\uD83C\uDFE2 [AUTH STATE] Checking organization for regular user...");let r=await e();console.log("\uD83C\uDFE2 [AUTH STATE] Organization result:",{data:r.data,error:r.error}),(s=r.data)?(console.log("✅ [AUTH STATE] User has organization, setting admin role"),l="admin"):console.log("❌ [AUTH STATE] User has no organization")}let u={id:r.user.id,email:r.user.email||"",firstName:(null===(t=r.user.user_metadata)||void 0===t?void 0:t.firstName)||"Demo",lastName:(null===(a=r.user.user_metadata)||void 0===a?void 0:a.lastName)||"User",role:l,organizationId:null==s?void 0:s.id,organization:s?{id:s.id,name:s.name,subscription_plan:s.subscription_plan}:void 0};console.log("\uD83D\uDC64 [AUTH STATE] Final user data set:",u),g(u),f(r.access_token),y(u,r.access_token)}else console.log("❌ [AUTH STATE] No session, clearing user data"),g(null),f(null),z();h(!1)});return()=>e.unsubscribe()},[]),(0,t.useEffect)(()=>{if(d){E();let e=()=>{E()};c.forEach(r=>{document.addEventListener(r,e,{passive:!0})});let r=setInterval(T,6e4);return()=>{D.current&&clearTimeout(D.current),clearInterval(r),c.forEach(r=>{document.removeEventListener(r,e)})}}},[d,E,T]);let U=async(e,r)=>{try{var o,t,a,s,l,u;if(h(!0),"noorg@example.com"===e){console.log("\uD83C\uDFAD [AUTH] Mock user login: noorg@example.com");let e={id:"no-org-user-id",email:"noorg@example.com",firstName:"No",lastName:"Organization",role:"user"};g(e),f("no-org-token"),y(e,"no-org-token"),console.log("\uD83C\uDFAD [AUTH] Mock user set, redirecting to organization-required"),p.push("/organization-required");return}if("demo@example.com"===e){console.log("\uD83C\uDFAD [AUTH] Mock user login: demo@example.com");let e={id:"demo-user-id",email:"demo@example.com",firstName:"Demo",lastName:"User",role:"admin",organizationId:"demo-company",organization:{id:"demo-company",name:"Demo Company"}};g(e),f("demo-token"),y(e,"demo-token"),console.log("\uD83C\uDFAD [AUTH] Mock user set with organization:",e.organization),p.push("/dashboard");return}console.log("\uD83D\uDD10 [AUTH] Starting Supabase login for:",e);let{data:c,error:d}=await (0,i.zB)(e,r);if(d)throw console.error("❌ [AUTH] Supabase login error:",d),d;if(console.log("✅ [AUTH] Supabase login successful:",{userId:null===(o=c.user)||void 0===o?void 0:o.id,email:null===(t=c.user)||void 0===t?void 0:t.email,hasSession:!!c.session}),c.user){let{getCurrentUserOrganization:e,isSuperAdmin:r}=await Promise.resolve().then(n.bind(n,5526));console.log("\uD83D\uDD0D [AUTH] Checking if user is super admin...");let o=await r(c.user.email||"");console.log("\uD83D\uDD0D [AUTH] Super admin check result: ".concat(o));let t=null,i="user";if(o)console.log("\uD83D\uDC51 [AUTH] User is super admin, setting system organization"),i="super_admin",t={id:"system",name:"System Administration"};else{console.log("\uD83C\uDFE2 [AUTH] Checking user organization...");let r=await e();console.log("\uD83C\uDFE2 [AUTH] Organization query result:",{data:r.data,error:r.error}),(t=r.data)?(console.log("✅ [AUTH] User has organization, setting admin role:",t),i="admin"):console.log("❌ [AUTH] User has no organization, keeping user role")}let d={id:c.user.id,email:c.user.email||"",firstName:(null===(a=c.user.user_metadata)||void 0===a?void 0:a.firstName)||"User",lastName:(null===(s=c.user.user_metadata)||void 0===s?void 0:s.lastName)||"",role:i,organizationId:null==t?void 0:t.id,organization:t?{id:t.id,name:t.name,subscription_plan:t.subscription_plan}:void 0};console.log("\uD83D\uDC64 [AUTH] Final user data:",d),g(d),f((null===(l=c.session)||void 0===l?void 0:l.access_token)||null),(null===(u=c.session)||void 0===u?void 0:u.access_token)&&y(d,c.session.access_token),o?(console.log("\uD83D\uDE80 [AUTH] Redirecting super admin to dashboard"),p.push("/dashboard")):t?(console.log("\uD83D\uDE80 [AUTH] Redirecting user with organization to dashboard"),p.push("/dashboard")):(console.log("\uD83D\uDE80 [AUTH] Redirecting user without organization to organization-required"),p.push("/organization-required"))}}catch(e){throw console.error("❌ [AUTH] Login error:",e),Error(e instanceof Error?e.message:"Login failed")}finally{h(!1)}},S=async e=>{try{h(!0);let{data:o,error:t}=await (0,i.y1)(e.email,e.password);if(t)throw t;if(o.user){var r,n;let t={id:o.user.id,email:o.user.email||"",first_name:e.firstName,last_name:e.lastName,organization_id:void 0,role:"user"},{error:a}=await (0,i.xv)(t);if(a)throw console.error("Failed to create user profile:",a),Error("Failed to create user profile: "+a.message);let s={id:o.user.id,email:o.user.email||"",firstName:e.firstName||"",lastName:e.lastName||"",role:"user",organizationId:void 0};g(s),f((null===(r=o.session)||void 0===r?void 0:r.access_token)||null),(null===(n=o.session)||void 0===n?void 0:n.access_token)&&y(s,o.session.access_token),p.push("/dashboard")}}catch(e){throw console.error("Registration error:",e),Error(e instanceof Error?e.message:"Registration failed")}finally{h(!1)}},I=(0,t.useCallback)(async()=>{try{D.current&&clearTimeout(D.current),z(),g(null),f(null),await (0,i.w7)(),p.push("/login")}catch(e){console.error("Logout error:",e),z(),g(null),f(null),p.push("/login")}},[z,p]);return(0,o.jsx)(s.Provider,{value:{user:d,token:m,login:U,register:S,logout:I,loading:_,resetInactivityTimer:E},children:r})}function m(){let e=(0,t.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},5526:function(e,r,n){n.d(r,{AW:function(){return H},Eb:function(){return R},Es:function(){return C},Ey:function(){return z},FR:function(){return x},FV:function(){return N},H$:function(){return m},IN:function(){return E},Jm:function(){return I},LQ:function(){return D},Lj:function(){return q},OL:function(){return h},OQ:function(){return a},PM:function(){return w},RN:function(){return S},Rg:function(){return y},Sy:function(){return p},X3:function(){return g},Yi:function(){return v},Yx:function(){return T},_O:function(){return P},_b:function(){return d},g5:function(){return M},getCurrentUserOrganization:function(){return c},isSuperAdmin:function(){return U},jX:function(){return f},l5:function(){return k},le:function(){return b},pH:function(){return O},ts:function(){return u},w7:function(){return l},xJ:function(){return A},xv:function(){return _},y0:function(){return B},y1:function(){return i},zB:function(){return s}});var o=n(6580);let t=()=>"localhost"===window.location.hostname?"http://localhost:3000":"https://githubpscl.github.io/DATACRM",a=(0,o.eI)("https://izqsytgmmykxtuwivpkd.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6cXN5dGdtbXlreHR1d2l2cGtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjcyNjIsImV4cCI6MjA2OTQwMzI2Mn0.mnMppDgUQjywUmVgGh87vq-jGRlFRFOr19Bc9nas43M",{auth:{persistSession:!0,autoRefreshToken:!0}}),i=async(e,r)=>{let{data:n,error:o}=await a.auth.signUp({email:e,password:r,options:{emailRedirectTo:t()}});return{data:n,error:o}},s=async(e,r)=>{let{data:n,error:o}=await a.auth.signInWithPassword({email:e,password:r});return{data:n,error:o}},l=async()=>{let{error:e}=await a.auth.signOut();return{error:e}},u=async()=>{let{data:{user:e}}=await a.auth.getUser();return e},c=async()=>{try{console.log("\uD83C\uDFE2 [SUPABASE] Calling RPC: get_current_user_organization");let{data:e,error:r}=await a.rpc("get_current_user_organization");if(console.log("\uD83C\uDFE2 [SUPABASE] RPC response:",{data:e,error:r,dataLength:e?e.length:0}),r)return console.error("❌ [SUPABASE] Error getting current user organization:",r),{data:null,error:r};let n=e&&e.length>0?e[0]:null;return console.log("\uD83C\uDFE2 [SUPABASE] Parsed organization:",n),{data:n,error:null}}catch(e){return console.error("❌ [SUPABASE] Exception in getCurrentUserOrganization:",e),{data:null,error:e}}},d=async()=>{let{data:e,error:r}=await a.rpc("get_available_organizations_for_join");return{data:e,error:r}},g=async e=>{let r=await u();if(!r)return{data:null,error:"Not authenticated"};let{data:n,error:o}=await a.from("organization_join_requests").insert([{user_id:r.id,organization_id:e.organization_id,requested_by_email:r.email,message:e.message}]).select().single();return{data:n,error:o}},m=async()=>{let{data:e,error:r}=await a.from("organization_join_requests").select("\n      *,\n      organization:organizations(name)\n    ").order("requested_at",{ascending:!1});return{data:e,error:r}},f=async()=>{let{data:e,error:r}=await a.from("organizations").select("*").order("created_at",{ascending:!1});return{data:e,error:r}},_=async e=>{let{data:r,error:n}=await a.from("users").insert([{id:e.id,email:e.email,first_name:e.first_name,last_name:e.last_name,organization_id:e.organization_id,role:e.role||"user",is_active:!0,is_verified:!1}]).select();return{data:r,error:n}},h=async()=>{var e;let r=await c();if(!r||!(null===(e=r.data)||void 0===e?void 0:e.id))return{data:[],error:"No organization found"};let{data:n,error:o}=await a.from("customers").select("\n      *,\n      contacts:customer_contacts (*),\n      activities:customer_activities (*)\n    ").eq("organization_id",r.data.id).order("created_at",{ascending:!1});return{data:n,error:o}},p=async e=>{var r;let n=await c();if(!(null==n?void 0:null===(r=n.data)||void 0===r?void 0:r.id))return{data:null,error:"No organization found"};let{data:o,error:t}=await a.from("customers").insert([{...e,organization_id:n.data.id,customer_status:e.customer_status||"lead",priority:e.priority||"normal",is_active:!0,is_verified:!1,language:"de",currency:"EUR"}]).select();return{data:o,error:t}},D=async e=>{var r;let n=await c();if(!(null==n?void 0:null===(r=n.data)||void 0===r?void 0:r.id))return{data:null,error:"No organization found"};let o=e.map(e=>({...e,organization_id:n.data.id,customer_status:"lead",priority:"normal",is_active:!0,is_verified:!1,language:"de",currency:"EUR"})),{data:t,error:i}=await a.from("customers").insert(o).select();return{data:t,error:i}},v=async e=>{try{console.log("Creating organization:",e);let r={name:e.name,email:e.admin_email||null,industry:e.industry||null,website:e.website||null,phone:e.phone||null,subscription_plan:"free",is_active:!0};console.log("Inserting organization data:",r);let{data:n,error:o}=await a.from("organizations").insert([r]).select().single();if(o)return console.error("Organization insert error:",o),{data:null,error:o};if(console.log("Organization created successfully:",n),e.admin_email){console.log("Attempting to assign admin role to:",e.admin_email),console.log("=== DEBUG: Checking all users first ===");let{data:r}=await a.from("users").select("id, email, role, organization_id");console.log("All users in database:",r),console.log("Total users found:",(null==r?void 0:r.length)||0),r&&r.forEach(e=>{console.log("User: ".concat(e.email," | ID: ").concat(e.id," | Role: ").concat(e.role," | Org: ").concat(e.organization_id))}),console.log("=== Searching for specific user ===");let{data:o,error:t}=await a.from("users").select("id, email, role").eq("email",e.admin_email).single();if(console.log("Search result for",e.admin_email,":",o),console.log("Search error:",t),t||!o)return console.error("User not found. Error details:",t),console.log("Available emails in database:"),r&&r.forEach(e=>console.log("- ".concat(e.email))),await a.from("organizations").delete().eq("id",n.id),{data:null,error:{message:'Admin-Benutzer mit E-Mail "'.concat(e.admin_email,'" wurde nicht in der Datenbank gefunden. Bitte stellen Sie sicher, dass sich der Benutzer zuerst registriert hat.\n\nVerf\xfcgbare Benutzer:\n').concat((null==r?void 0:r.map(e=>"- ".concat(e.email)).join("\n"))||"Keine Benutzer gefunden"),code:"USER_NOT_FOUND"}};console.log("Found admin user:",o);let{error:i}=await a.from("users").update({organization_id:n.id,role:"org_admin"}).eq("id",o.id);if(i)return console.error("Error updating user role:",i),await a.from("organizations").delete().eq("id",n.id),{data:null,error:{message:"Fehler beim Zuweisen der Admin-Rolle: ".concat(i.message),details:i}};console.log("Admin role assigned successfully")}return{data:n,error:null}}catch(e){return console.error("Unexpected error in createOrganization:",e),{data:null,error:{message:e instanceof Error?e.message:"Unknown error occurred",details:e}}}},y=async(e,r)=>{let{data:n,error:o}=await a.from("user_roles").select("\n      *,\n      role:roles(*),\n      organization:organizations(*)\n    ").eq("user_id",e).eq("org_id",r||null).single();return{data:n,error:o}},z=async e=>{let{data:r,error:n}=await a.from("user_roles").insert([e]).select();return{data:r,error:n}},w=async e=>{let{data:r,error:n}=await a.from("user_permissions").insert([e]).select();return{data:r,error:n}},A=async()=>{let{data:e,error:r}=await a.from("roles").select("*").order("level",{ascending:!1});return{data:e,error:r}},E=async()=>{let{data:e,error:r}=await a.from("permissions").select("*").order("category",{ascending:!0});return{data:e,error:r}},T=async e=>{let{data:r,error:n}=await a.from("user_roles").select("\n      *,\n      user:profiles(*),\n      role:roles(*)\n    ").eq("org_id",e);return{data:r,error:n}},U=async e=>{if(console.log("=== isSuperAdmin Check ==="),console.log("Checking email:",e),["testdatacrmpascal@gmail.com","admin@datacrm.system"].includes(e))return console.log("✅ User is hardcoded super admin"),!0;try{console.log("\uD83D\uDD0D Checking database for super_admin role...");let{data:r,error:n}=await a.from("users").select("role, is_active").eq("email",e).single();if(console.log("Database query result:",{data:r,error:n}),n)return console.log("❌ Database error:",n.message),!1;let o=(null==r?void 0:r.role)==="super_admin"&&(null==r?void 0:r.is_active)===!0;return console.log("Database super admin check result:",o),console.log("User role:",null==r?void 0:r.role,"Is active:",null==r?void 0:r.is_active),o}catch(e){return console.error("❌ Unexpected error in isSuperAdmin:",e),!1}},S=async e=>{try{let{data:r,error:n}=await a.from("user_roles").select("role").eq("user_id",e).eq("role","org_admin").single();if(n&&"PGRST116"!==n.code)return console.error("Error checking org admin status:",n),!1;return!!r}catch(e){return console.error("Error in isOrgAdmin:",e),!1}},I=async()=>{try{let{data:e,error:r}=await a.from("user_roles").select("\n        id,\n        user_id,\n        organization_id,\n        role,\n        created_at,\n        organizations!organization_id(name)\n      ");if(r)return console.error("Error getting user roles:",r),{data:[],error:r};return{data:(null==e?void 0:e.map(e=>{var r,n;return{...e,user:{email:"user-".concat(e.user_id.slice(0,8),"@example.com")},organization:{name:Array.isArray(e.organizations)?(null===(r=e.organizations[0])||void 0===r?void 0:r.name)||"Unknown Organization":(null===(n=e.organizations)||void 0===n?void 0:n.name)||"Unknown Organization"}}}))||[],error:null}}catch(e){return console.error("Error in getUserRoles:",e),{data:[],error:e}}},C=async(e,r,n)=>{try{let{data:o,error:t}=await a.from("user_roles").upsert({user_id:e,organization_id:n,role:r,created_at:new Date().toISOString()}).select();if(t)return console.error("Error assigning role:",t),{data:null,error:t};return{data:o,error:null}}catch(e){return console.error("Error in assignRole:",e),{data:null,error:e}}},k=async(e,r)=>{try{let{data:n,error:o}=await a.from("user_roles").delete().eq("user_id",e).eq("organization_id",r);if(o)return console.error("Error removing role:",o),{data:null,error:o};return{data:n,error:null}}catch(e){return console.error("Error in removeRole:",e),{data:null,error:e}}},N=async(e,r)=>{try{let{data:n,error:o}=await a.from("organizations").update(r).eq("id",e).select();if(o)return console.error("Error updating organization:",o),{data:null,error:o};return{data:n,error:null}}catch(e){return console.error("Error in updateOrganization:",e),{data:null,error:e}}},b=async(e,r)=>{try{let{data:n,error:o}=await a.from("profiles").select("id").eq("email",e).single();if(o||!n)return{data:null,error:{message:"Benutzer nicht gefunden"}};let{data:t}=await a.from("user_roles").select("id").eq("user_id",n.id).eq("organization_id",r).single();if(t)return{data:null,error:{message:"Benutzer ist bereits Mitglied dieser Organisation"}};let{data:i,error:s}=await a.from("user_roles").insert({user_id:n.id,organization_id:r,role:"org_admin"}).select();if(s)return console.error("Error adding admin to organization:",s),{data:null,error:s};return{data:i,error:null}}catch(e){return console.error("Error in addAdminToOrg:",e),{data:null,error:e}}},H=async()=>{try{let{data:e,error:r}=await a.from("profiles").select("\n        *,\n        user_roles (\n          role,\n          organization:organizations (\n            id,\n            name\n          )\n        )\n      ").order("created_at",{ascending:!1});if(r)return console.error("Error getting all users:",r),{data:null,error:r};return{data:e,error:null}}catch(e){return console.error("Error in getAllUsers:",e),{data:null,error:e}}},O=async()=>{try{let{data:e,error:r}=await a.from("profiles").select("*").not("id","in",a.from("user_roles").select("user_id")).order("created_at",{ascending:!1});if(r)return console.error("Error getting unassigned users:",r),{data:null,error:r};return{data:e,error:null}}catch(e){return console.error("Error in getUnassignedUsers:",e),{data:null,error:e}}},q=async(e,r)=>{try{let{data:n,error:o}=await a.from("profiles").update(r).eq("id",e).select();if(o)return console.error("Error updating user profile:",o),{data:null,error:o};return{data:n,error:null}}catch(e){return console.error("Error in updateUserProfile:",e),{data:null,error:e}}},R=async()=>{try{var e;let r=await c();if(!r||!(null===(e=r.data)||void 0===e?void 0:e.id))return{data:null,error:"No organization found"};let{data:n,error:o}=await a.from("customers").select("*").eq("organization_id",r.data.id);if(o)return console.error("Error loading customers for analytics:",o),{data:null,error:o};let t=(null==n?void 0:n.length)||0,i=(null==n?void 0:n.filter(e=>"customer"===e.customer_status).length)||0,s=(null==n?void 0:n.filter(e=>"lead"===e.customer_status).length)||0,l=(null==n?void 0:n.filter(e=>"prospect"===e.customer_status).length)||0,u=new Date;u.setDate(1),u.setHours(0,0,0,0);let d=(null==n?void 0:n.filter(e=>new Date(e.created_at)>=u).length)||0,g=(null==n?void 0:n.reduce((e,r)=>(e[r.customer_status]=(e[r.customer_status]||0)+1,e),{}))||{},m=(null==n?void 0:n.reduce((e,r)=>(e[r.customer_type]=(e[r.customer_type]||0)+1,e),{person:0,company:0}))||{person:0,company:0},f=(null==n?void 0:n.reduce((e,r)=>(r.industry&&(e[r.industry]=(e[r.industry]||0)+1),e),{}))||{},_=Object.entries(f).map(e=>{let[r,n]=e;return{industry:r,count:n}}).sort((e,r)=>r.count-e.count).slice(0,5);return{data:{totalCustomers:t,activeCustomers:i,newCustomersThisMonth:d,leadsCount:s,prospectsCount:l,customerGrowthRate:Math.round(10*(t>0?d/t*100:0))/10,customersByStatus:g,customersByType:m,topIndustries:_},error:null}}catch(e){return console.error("Error in getAnalyticsData:",e),{data:null,error:e}}},F=async e=>{try{let{data:r,error:n}=await a.from("users").select("id",{count:"exact"}).eq("organization_id",e).eq("is_active",!0);if(n)return console.error("Error getting user count:",n),{data:null,error:n};return{data:(null==r?void 0:r.length)||0,error:null}}catch(e){return console.error("Error in getOrganizationUserCount:",e),{data:null,error:e}}},x=async()=>{try{let{data:e,error:r}=await a.from("organizations").select("*").eq("is_active",!0).order("name");if(r)return console.error("Error getting organizations:",r),{data:null,error:r};if(!e)return{data:[],error:null};return{data:await Promise.all(e.map(async e=>{let{data:r}=await F(e.id);return{...e,user_count:r||0,created_at:e.created_at||new Date().toISOString()}})),error:null}}catch(e){return console.error("Error in getAllOrganizationsWithUserCounts:",e),{data:null,error:e}}},P=async e=>{try{let{data:r,error:n}=await a.from("users").select("\n        id,\n        email,\n        first_name,\n        last_name,\n        role,\n        is_active,\n        created_at,\n        organization_id\n      ").eq("organization_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(n)return console.error("Error getting organization users:",n),{data:null,error:n};return{data:r||[],error:null}}catch(e){return console.error("Error in getOrganizationUsers:",e),{data:null,error:e}}},B=async e=>{try{let{data:r,error:n}=await a.auth.admin.createUser({email:e.email,password:e.temporary_password||"TempPass123!",email_confirm:!0});if(n)return console.error("Error creating auth user:",n),{data:null,error:n};if(!r.user)return{data:null,error:"Failed to create user"};let{data:o,error:t}=await a.from("users").insert([{id:r.user.id,email:e.email,first_name:e.first_name,last_name:e.last_name,organization_id:e.organization_id,role:e.role||"user",is_active:!0}]).select().single();if(t)return console.error("Error creating user profile:",t),await a.auth.admin.deleteUser(r.user.id),{data:null,error:t};return{data:o,error:null}}catch(e){return console.error("Error in addUserToOrganization:",e),{data:null,error:e}}},M=async e=>B({...e,role:"org_admin"})}}]);
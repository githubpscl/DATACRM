"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7182],{7182:function(e,r,t){t.d(r,{AuthProvider:function(){return m},a:function(){return g},k:function(){return d}});var n=t(7437),a=t(2265),o=t(9376),i=t(5526);let s=(0,a.createContext)(void 0),l="datacrm-auth-session",u="datacrm-last-activity",c=["mousedown","mousemove","keypress","scroll","touchstart","click"],d=async e=>{let{data:{session:r}}=await i.OQ.auth.getSession();if(!(null==r?void 0:r.access_token)&&e.includes("/auth/"))throw Error("Not authenticated");return(await new Promise(e=>setTimeout(e,500)),e.includes("/analytics"))?{analytics:null}:e.includes("/customers")?{customers:[]}:e.includes("/campaigns")?{campaigns:[]}:{data:null}};function m(e){let{children:r}=e,[d,m]=(0,a.useState)(null),[g,f]=(0,a.useState)(null),[_,p]=(0,a.useState)(!0),h=(0,o.useRouter)(),v=(0,a.useRef)(null),y=(0,a.useRef)(Date.now()),w=(0,a.useCallback)((e,r)=>{try{let t={user:e,token:r,timestamp:Date.now()};localStorage.setItem(l,JSON.stringify(t)),localStorage.setItem(u,Date.now().toString())}catch(e){console.error("Error saving session:",e)}},[]),z=(0,a.useCallback)(()=>{try{localStorage.removeItem(l),localStorage.removeItem(u)}catch(e){console.error("Error clearing session:",e)}},[]),E=(0,a.useCallback)(()=>{try{let e=localStorage.getItem(l),r=localStorage.getItem(u);if(e&&r){let t=JSON.parse(e),n=parseInt(r);if(Date.now()-n<6e5)return m(t.user),f(t.token),y.current=n,!0;z()}}catch(e){console.error("Error loading session:",e),z()}return!1},[z]),b=(0,a.useCallback)(()=>{let e=Date.now();y.current=e;try{localStorage.setItem(u,e.toString())}catch(e){console.error("Error updating last activity:",e)}},[]),k=(0,a.useCallback)(()=>{v.current&&clearTimeout(v.current),b(),v.current=setTimeout(()=>{console.log("Session expired due to inactivity"),z(),m(null),f(null),window.location.href="/login"},6e5)},[b,z]),I=(0,a.useCallback)(()=>{let e=parseInt(localStorage.getItem(u)||"0"),r=Date.now();d&&r-e>6e5&&(console.log("Session expired during validity check"),z(),m(null),f(null),window.location.href="/login")},[d,z]);(0,a.useEffect)(()=>{(async()=>{try{if(!E()){let{data:{session:n}}=await i.OQ.auth.getSession();if(null==n?void 0:n.user){var e,r;let{getCurrentUserOrganization:a,isSuperAdmin:o}=await Promise.resolve().then(t.bind(t,5526)),i=await o(n.user.email||""),s=null;if(!i){let{data:e}=await a();s=e}let l={id:n.user.id,email:n.user.email||"",firstName:(null===(e=n.user.user_metadata)||void 0===e?void 0:e.firstName)||"Demo",lastName:(null===(r=n.user.user_metadata)||void 0===r?void 0:r.lastName)||"User",role:i?"super_admin":"admin",organizationId:null==s?void 0:s.id,organization:s?{id:s.id,name:s.name,subscription_plan:s.subscription_plan}:void 0};m(l),f(n.access_token),w(l,n.access_token)}}}catch(e){console.error("Error initializing auth:",e)}finally{p(!1)}})();let{data:{subscription:e}}=i.OQ.auth.onAuthStateChange(async(e,r)=>{if(null==r?void 0:r.user){var n,a;let{getCurrentUserOrganization:e,isSuperAdmin:o}=await Promise.resolve().then(t.bind(t,5526)),i=await o(r.user.email||""),s=null;if(!i){let{data:r}=await e();s=r}let l={id:r.user.id,email:r.user.email||"",firstName:(null===(n=r.user.user_metadata)||void 0===n?void 0:n.firstName)||"Demo",lastName:(null===(a=r.user.user_metadata)||void 0===a?void 0:a.lastName)||"User",role:i?"super_admin":"admin",organizationId:null==s?void 0:s.id,organization:s?{id:s.id,name:s.name,subscription_plan:s.subscription_plan}:void 0};m(l),f(r.access_token),w(l,r.access_token)}else m(null),f(null),z();p(!1)});return()=>e.unsubscribe()},[]),(0,a.useEffect)(()=>{if(d){k();let e=()=>{k()};c.forEach(r=>{document.addEventListener(r,e,{passive:!0})});let r=setInterval(I,6e4);return()=>{v.current&&clearTimeout(v.current),clearInterval(r),c.forEach(r=>{document.removeEventListener(r,e)})}}},[d,k,I]);let N=async(e,r)=>{try{if(p(!0),"noorg@example.com"===e){let e={id:"no-org-user-id",email:"noorg@example.com",firstName:"No",lastName:"Organization",role:"user"};m(e),f("no-org-token"),w(e,"no-org-token"),h.push("/organization-required");return}if("demo@example.com"===e){let e={id:"demo-user-id",email:"demo@example.com",firstName:"Demo",lastName:"User",role:"admin",organizationId:"demo-company",organization:{id:"demo-company",name:"Demo Company"}};m(e),f("demo-token"),w(e,"demo-token"),h.push("/dashboard");return}if("testdatacrmpascal@gmail.com"===e){let e={id:"super-admin-id",email:"testdatacrmpascal@gmail.com",firstName:"Super",lastName:"Admin",role:"super_admin",organizationId:"system",organization:{id:"system",name:"System Administration"}};m(e),f("super-admin-token"),w(e,"super-admin-token"),h.push("/dashboard");return}let{data:l,error:u}=await (0,i.zB)(e,r);if(u)throw u;if(l.user){var n,a,o,s;let{getCurrentUserOrganization:e,isSuperAdmin:r}=await Promise.resolve().then(t.bind(t,5526)),i=await r(l.user.email||""),u=null;if(!i){let{data:r}=await e();u=r}let c={id:l.user.id,email:l.user.email||"",firstName:(null===(n=l.user.user_metadata)||void 0===n?void 0:n.firstName)||"User",lastName:(null===(a=l.user.user_metadata)||void 0===a?void 0:a.lastName)||"",role:i?"super_admin":"user",organizationId:null==u?void 0:u.id,organization:u?{id:u.id,name:u.name,subscription_plan:u.subscription_plan}:void 0};m(c),f((null===(o=l.session)||void 0===o?void 0:o.access_token)||null),(null===(s=l.session)||void 0===s?void 0:s.access_token)&&w(c,l.session.access_token),i||u?h.push("/dashboard"):h.push("/organization-required")}}catch(e){throw console.error("Login error:",e),Error(e instanceof Error?e.message:"Login failed")}finally{p(!1)}},S=async e=>{try{p(!0);let{data:n,error:a}=await (0,i.y1)(e.email,e.password);if(a)throw a;if(n.user){var r,t;let a={id:n.user.id,email:n.user.email||"",first_name:e.firstName,last_name:e.lastName,organization_id:void 0,role:"user"},{error:o}=await (0,i.xv)(a);if(o)throw console.error("Failed to create user profile:",o),Error("Failed to create user profile: "+o.message);let s={id:n.user.id,email:n.user.email||"",firstName:e.firstName||"",lastName:e.lastName||"",role:"user",organizationId:void 0};m(s),f((null===(r=n.session)||void 0===r?void 0:r.access_token)||null),(null===(t=n.session)||void 0===t?void 0:t.access_token)&&w(s,n.session.access_token),h.push("/dashboard")}}catch(e){throw console.error("Registration error:",e),Error(e instanceof Error?e.message:"Registration failed")}finally{p(!1)}},O=(0,a.useCallback)(async()=>{try{v.current&&clearTimeout(v.current),z(),m(null),f(null),await (0,i.w7)(),h.push("/login")}catch(e){console.error("Logout error:",e),z(),m(null),f(null),h.push("/login")}},[z,h]);return(0,n.jsx)(s.Provider,{value:{user:d,token:g,login:N,register:S,logout:O,loading:_,resetInactivityTimer:k},children:r})}function g(){let e=(0,a.useContext)(s);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}},5526:function(e,r,t){t.d(r,{AW:function(){return A},Eb:function(){return T},Es:function(){return U},Ey:function(){return z},FR:function(){return M},FV:function(){return D},H$:function(){return g},IN:function(){return k},Jm:function(){return O},LQ:function(){return v},Lj:function(){return x},OL:function(){return p},OQ:function(){return o},PM:function(){return E},RN:function(){return S},Rg:function(){return w},Sy:function(){return h},X3:function(){return m},Yi:function(){return y},Yx:function(){return I},_O:function(){return P},_b:function(){return d},g5:function(){return F},getCurrentUserOrganization:function(){return c},isSuperAdmin:function(){return N},jX:function(){return f},l5:function(){return q},le:function(){return C},pH:function(){return R},ts:function(){return u},w7:function(){return l},xJ:function(){return b},xv:function(){return _},y0:function(){return B},y1:function(){return i},zB:function(){return s}});var n=t(6580);let a=()=>"localhost"===window.location.hostname?"http://localhost:3000":"https://githubpscl.github.io/DATACRM",o=(0,n.eI)("https://izqsytgmmykxtuwivpkd.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml6cXN5dGdtbXlreHR1d2l2cGtkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4MjcyNjIsImV4cCI6MjA2OTQwMzI2Mn0.mnMppDgUQjywUmVgGh87vq-jGRlFRFOr19Bc9nas43M",{auth:{persistSession:!0,autoRefreshToken:!0}}),i=async(e,r)=>{let{data:t,error:n}=await o.auth.signUp({email:e,password:r,options:{emailRedirectTo:a()}});return{data:t,error:n}},s=async(e,r)=>{let{data:t,error:n}=await o.auth.signInWithPassword({email:e,password:r});return{data:t,error:n}},l=async()=>{let{error:e}=await o.auth.signOut();return{error:e}},u=async()=>{let{data:{user:e}}=await o.auth.getUser();return e},c=async()=>{try{let{data:e,error:r}=await o.rpc("get_current_user_organization");if(r)return console.error("Error getting current user organization:",r),{data:null,error:r};return{data:e&&e.length>0?e[0]:null,error:null}}catch(e){return console.error("Error in getCurrentUserOrganization:",e),{data:null,error:e}}},d=async()=>{let{data:e,error:r}=await o.rpc("get_available_organizations_for_join");return{data:e,error:r}},m=async e=>{let r=await u();if(!r)return{data:null,error:"Not authenticated"};let{data:t,error:n}=await o.from("organization_join_requests").insert([{user_id:r.id,organization_id:e.organization_id,requested_by_email:r.email,message:e.message}]).select().single();return{data:t,error:n}},g=async()=>{let{data:e,error:r}=await o.from("organization_join_requests").select("\n      *,\n      organization:organizations(name)\n    ").order("requested_at",{ascending:!1});return{data:e,error:r}},f=async()=>{let{data:e,error:r}=await o.from("organizations").select("*").order("created_at",{ascending:!1});return{data:e,error:r}},_=async e=>{let{data:r,error:t}=await o.from("users").insert([{id:e.id,email:e.email,first_name:e.first_name,last_name:e.last_name,organization_id:e.organization_id,role:e.role||"user",is_active:!0,is_verified:!1}]).select();return{data:r,error:t}},p=async()=>{var e;let r=await c();if(!r||!(null===(e=r.data)||void 0===e?void 0:e.id))return{data:[],error:"No organization found"};let{data:t,error:n}=await o.from("customers").select("\n      *,\n      contacts:customer_contacts (*),\n      activities:customer_activities (*)\n    ").eq("organization_id",r.data.id).order("created_at",{ascending:!1});return{data:t,error:n}},h=async e=>{var r;let t=await c();if(!(null==t?void 0:null===(r=t.data)||void 0===r?void 0:r.id))return{data:null,error:"No organization found"};let{data:n,error:a}=await o.from("customers").insert([{...e,organization_id:t.data.id,customer_status:e.customer_status||"lead",priority:e.priority||"normal",is_active:!0,is_verified:!1,language:"de",currency:"EUR"}]).select();return{data:n,error:a}},v=async e=>{var r;let t=await c();if(!(null==t?void 0:null===(r=t.data)||void 0===r?void 0:r.id))return{data:null,error:"No organization found"};let n=e.map(e=>({...e,organization_id:t.data.id,customer_status:"lead",priority:"normal",is_active:!0,is_verified:!1,language:"de",currency:"EUR"})),{data:a,error:i}=await o.from("customers").insert(n).select();return{data:a,error:i}},y=async e=>{try{console.log("Creating organization:",e);let r={name:e.name,email:e.admin_email||null,industry:e.industry||null,website:e.website||null,phone:e.phone||null,subscription_plan:"free",is_active:!0};console.log("Inserting organization data:",r);let{data:t,error:n}=await o.from("organizations").insert([r]).select().single();if(n)return console.error("Organization insert error:",n),{data:null,error:n};if(console.log("Organization created successfully:",t),e.admin_email){console.log("Attempting to assign admin role to:",e.admin_email),console.log("=== DEBUG: Checking all users first ===");let{data:r}=await o.from("users").select("id, email, role, organization_id");console.log("All users in database:",r),console.log("Total users found:",(null==r?void 0:r.length)||0),r&&r.forEach(e=>{console.log("User: ".concat(e.email," | ID: ").concat(e.id," | Role: ").concat(e.role," | Org: ").concat(e.organization_id))}),console.log("=== Searching for specific user ===");let{data:n,error:a}=await o.from("users").select("id, email, role").eq("email",e.admin_email).single();if(console.log("Search result for",e.admin_email,":",n),console.log("Search error:",a),a||!n)return console.error("User not found. Error details:",a),console.log("Available emails in database:"),r&&r.forEach(e=>console.log("- ".concat(e.email))),await o.from("organizations").delete().eq("id",t.id),{data:null,error:{message:'Admin-Benutzer mit E-Mail "'.concat(e.admin_email,'" wurde nicht in der Datenbank gefunden. Bitte stellen Sie sicher, dass sich der Benutzer zuerst registriert hat.\n\nVerf\xfcgbare Benutzer:\n').concat((null==r?void 0:r.map(e=>"- ".concat(e.email)).join("\n"))||"Keine Benutzer gefunden"),code:"USER_NOT_FOUND"}};console.log("Found admin user:",n);let{error:i}=await o.from("users").update({organization_id:t.id,role:"org_admin"}).eq("id",n.id);if(i)return console.error("Error updating user role:",i),await o.from("organizations").delete().eq("id",t.id),{data:null,error:{message:"Fehler beim Zuweisen der Admin-Rolle: ".concat(i.message),details:i}};console.log("Admin role assigned successfully")}return{data:t,error:null}}catch(e){return console.error("Unexpected error in createOrganization:",e),{data:null,error:{message:e instanceof Error?e.message:"Unknown error occurred",details:e}}}},w=async(e,r)=>{let{data:t,error:n}=await o.from("user_roles").select("\n      *,\n      role:roles(*),\n      organization:organizations(*)\n    ").eq("user_id",e).eq("org_id",r||null).single();return{data:t,error:n}},z=async e=>{let{data:r,error:t}=await o.from("user_roles").insert([e]).select();return{data:r,error:t}},E=async e=>{let{data:r,error:t}=await o.from("user_permissions").insert([e]).select();return{data:r,error:t}},b=async()=>{let{data:e,error:r}=await o.from("roles").select("*").order("level",{ascending:!1});return{data:e,error:r}},k=async()=>{let{data:e,error:r}=await o.from("permissions").select("*").order("category",{ascending:!0});return{data:e,error:r}},I=async e=>{let{data:r,error:t}=await o.from("user_roles").select("\n      *,\n      user:profiles(*),\n      role:roles(*)\n    ").eq("org_id",e);return{data:r,error:t}},N=async e=>{if(console.log("=== isSuperAdmin Check ==="),console.log("Checking email:",e),["testdatacrmpascal@gmail.com","admin@datacrm.system"].includes(e))return console.log("✅ User is hardcoded super admin"),!0;try{console.log("\uD83D\uDD0D Checking database for super_admin role...");let{data:r,error:t}=await o.from("users").select("role, is_active").eq("email",e).single();if(console.log("Database query result:",{data:r,error:t}),t)return console.log("❌ Database error:",t.message),!1;let n=(null==r?void 0:r.role)==="super_admin"&&(null==r?void 0:r.is_active)===!0;return console.log("Database super admin check result:",n),console.log("User role:",null==r?void 0:r.role,"Is active:",null==r?void 0:r.is_active),n}catch(e){return console.error("❌ Unexpected error in isSuperAdmin:",e),!1}},S=async e=>{try{let{data:r,error:t}=await o.from("user_roles").select("role").eq("user_id",e).eq("role","org_admin").single();if(t&&"PGRST116"!==t.code)return console.error("Error checking org admin status:",t),!1;return!!r}catch(e){return console.error("Error in isOrgAdmin:",e),!1}},O=async()=>{try{let{data:e,error:r}=await o.from("user_roles").select("\n        id,\n        user_id,\n        organization_id,\n        role,\n        created_at,\n        organizations!organization_id(name)\n      ");if(r)return console.error("Error getting user roles:",r),{data:[],error:r};return{data:(null==e?void 0:e.map(e=>{var r,t;return{...e,user:{email:"user-".concat(e.user_id.slice(0,8),"@example.com")},organization:{name:Array.isArray(e.organizations)?(null===(r=e.organizations[0])||void 0===r?void 0:r.name)||"Unknown Organization":(null===(t=e.organizations)||void 0===t?void 0:t.name)||"Unknown Organization"}}}))||[],error:null}}catch(e){return console.error("Error in getUserRoles:",e),{data:[],error:e}}},U=async(e,r,t)=>{try{let{data:n,error:a}=await o.from("user_roles").upsert({user_id:e,organization_id:t,role:r,created_at:new Date().toISOString()}).select();if(a)return console.error("Error assigning role:",a),{data:null,error:a};return{data:n,error:null}}catch(e){return console.error("Error in assignRole:",e),{data:null,error:e}}},q=async(e,r)=>{try{let{data:t,error:n}=await o.from("user_roles").delete().eq("user_id",e).eq("organization_id",r);if(n)return console.error("Error removing role:",n),{data:null,error:n};return{data:t,error:null}}catch(e){return console.error("Error in removeRole:",e),{data:null,error:e}}},D=async(e,r)=>{try{let{data:t,error:n}=await o.from("organizations").update(r).eq("id",e).select();if(n)return console.error("Error updating organization:",n),{data:null,error:n};return{data:t,error:null}}catch(e){return console.error("Error in updateOrganization:",e),{data:null,error:e}}},C=async(e,r)=>{try{let{data:t,error:n}=await o.from("profiles").select("id").eq("email",e).single();if(n||!t)return{data:null,error:{message:"Benutzer nicht gefunden"}};let{data:a}=await o.from("user_roles").select("id").eq("user_id",t.id).eq("organization_id",r).single();if(a)return{data:null,error:{message:"Benutzer ist bereits Mitglied dieser Organisation"}};let{data:i,error:s}=await o.from("user_roles").insert({user_id:t.id,organization_id:r,role:"org_admin"}).select();if(s)return console.error("Error adding admin to organization:",s),{data:null,error:s};return{data:i,error:null}}catch(e){return console.error("Error in addAdminToOrg:",e),{data:null,error:e}}},A=async()=>{try{let{data:e,error:r}=await o.from("profiles").select("\n        *,\n        user_roles (\n          role,\n          organization:organizations (\n            id,\n            name\n          )\n        )\n      ").order("created_at",{ascending:!1});if(r)return console.error("Error getting all users:",r),{data:null,error:r};return{data:e,error:null}}catch(e){return console.error("Error in getAllUsers:",e),{data:null,error:e}}},R=async()=>{try{let{data:e,error:r}=await o.from("profiles").select("*").not("id","in",o.from("user_roles").select("user_id")).order("created_at",{ascending:!1});if(r)return console.error("Error getting unassigned users:",r),{data:null,error:r};return{data:e,error:null}}catch(e){return console.error("Error in getUnassignedUsers:",e),{data:null,error:e}}},x=async(e,r)=>{try{let{data:t,error:n}=await o.from("profiles").update(r).eq("id",e).select();if(n)return console.error("Error updating user profile:",n),{data:null,error:n};return{data:t,error:null}}catch(e){return console.error("Error in updateUserProfile:",e),{data:null,error:e}}},T=async()=>{try{var e;let r=await c();if(!r||!(null===(e=r.data)||void 0===e?void 0:e.id))return{data:null,error:"No organization found"};let{data:t,error:n}=await o.from("customers").select("*").eq("organization_id",r.data.id);if(n)return console.error("Error loading customers for analytics:",n),{data:null,error:n};let a=(null==t?void 0:t.length)||0,i=(null==t?void 0:t.filter(e=>"customer"===e.customer_status).length)||0,s=(null==t?void 0:t.filter(e=>"lead"===e.customer_status).length)||0,l=(null==t?void 0:t.filter(e=>"prospect"===e.customer_status).length)||0,u=new Date;u.setDate(1),u.setHours(0,0,0,0);let d=(null==t?void 0:t.filter(e=>new Date(e.created_at)>=u).length)||0,m=(null==t?void 0:t.reduce((e,r)=>(e[r.customer_status]=(e[r.customer_status]||0)+1,e),{}))||{},g=(null==t?void 0:t.reduce((e,r)=>(e[r.customer_type]=(e[r.customer_type]||0)+1,e),{person:0,company:0}))||{person:0,company:0},f=(null==t?void 0:t.reduce((e,r)=>(r.industry&&(e[r.industry]=(e[r.industry]||0)+1),e),{}))||{},_=Object.entries(f).map(e=>{let[r,t]=e;return{industry:r,count:t}}).sort((e,r)=>r.count-e.count).slice(0,5);return{data:{totalCustomers:a,activeCustomers:i,newCustomersThisMonth:d,leadsCount:s,prospectsCount:l,customerGrowthRate:Math.round(10*(a>0?d/a*100:0))/10,customersByStatus:m,customersByType:g,topIndustries:_},error:null}}catch(e){return console.error("Error in getAnalyticsData:",e),{data:null,error:e}}},j=async e=>{try{let{data:r,error:t}=await o.from("users").select("id",{count:"exact"}).eq("organization_id",e).eq("is_active",!0);if(t)return console.error("Error getting user count:",t),{data:null,error:t};return{data:(null==r?void 0:r.length)||0,error:null}}catch(e){return console.error("Error in getOrganizationUserCount:",e),{data:null,error:e}}},M=async()=>{try{let{data:e,error:r}=await o.from("organizations").select("*").eq("is_active",!0).order("name");if(r)return console.error("Error getting organizations:",r),{data:null,error:r};if(!e)return{data:[],error:null};return{data:await Promise.all(e.map(async e=>{let{data:r}=await j(e.id);return{...e,user_count:r||0,created_at:e.created_at||new Date().toISOString()}})),error:null}}catch(e){return console.error("Error in getAllOrganizationsWithUserCounts:",e),{data:null,error:e}}},P=async e=>{try{let{data:r,error:t}=await o.from("users").select("\n        id,\n        email,\n        first_name,\n        last_name,\n        role,\n        is_active,\n        created_at,\n        organization_id\n      ").eq("organization_id",e).eq("is_active",!0).order("created_at",{ascending:!1});if(t)return console.error("Error getting organization users:",t),{data:null,error:t};return{data:r||[],error:null}}catch(e){return console.error("Error in getOrganizationUsers:",e),{data:null,error:e}}},B=async e=>{try{let{data:r,error:t}=await o.auth.admin.createUser({email:e.email,password:e.temporary_password||"TempPass123!",email_confirm:!0});if(t)return console.error("Error creating auth user:",t),{data:null,error:t};if(!r.user)return{data:null,error:"Failed to create user"};let{data:n,error:a}=await o.from("users").insert([{id:r.user.id,email:e.email,first_name:e.first_name,last_name:e.last_name,organization_id:e.organization_id,role:e.role||"user",is_active:!0}]).select().single();if(a)return console.error("Error creating user profile:",a),await o.auth.admin.deleteUser(r.user.id),{data:null,error:a};return{data:n,error:null}}catch(e){return console.error("Error in addUserToOrganization:",e),{data:null,error:e}}},F=async e=>B({...e,role:"org_admin"})}}]);